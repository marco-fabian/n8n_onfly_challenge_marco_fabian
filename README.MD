# n8n Random Node - Custom Connector

[![CI/CD Pipeline](https://github.com/marco-fabian/n8n_onfly_challenge_marco_fabian/workflows/CI/CD%20Pipeline/badge.svg)](https://github.com/marco-fabian/n8n_onfly_challenge_marco_fabian/actions)
[![Tests](https://img.shields.io/badge/tests-passing-brightgreen)](https://github.com/marco-fabian/n8n_onfly_challenge_marco_fabian/actions)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Node.js](https://img.shields.io/badge/node.js-18%2B-green.svg)](https://nodejs.org/)

Este projeto implementa um conector personalizado para n8n que gera n√∫meros aleat√≥rios usando a API do Random.org.

## üéØ Objetivo

Criar um conector personalizado para n8n com:
- **Nome**: Random
- **Opera√ß√£o**: "True Random Number Generator"
- **Inputs**: Min e Max (n√∫meros inteiros inclusos)
- **Integra√ß√£o**: API do Random.org com fallback local

## üìÅ Estrutura do Projeto

```
n8n_onfly_challenge_marco_fabian/
‚îú‚îÄ‚îÄ n8n-infra/                    # Infraestrutura Docker
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml        # Configura√ß√£o n8n + PostgreSQL
‚îÇ   ‚îú‚îÄ‚îÄ .env.example             # Vari√°veis de ambiente exemplo
‚îÇ   ‚îî‚îÄ‚îÄ .env                     # Vari√°veis de ambiente (n√£o versionado)
‚îú‚îÄ‚îÄ n8n-node-random/             # Custom Node
‚îÇ   ‚îú‚îÄ‚îÄ src/nodes/Random/        # C√≥digo fonte TypeScript
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Random.node.ts       # Implementa√ß√£o do n√≥
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ random.svg           # √çcone do n√≥
‚îÇ   ‚îú‚îÄ‚îÄ dist/                    # C√≥digo compilado (gerado automaticamente)
‚îÇ   ‚îú‚îÄ‚îÄ package.json             # Configura√ß√£o do pacote
‚îÇ   ‚îî‚îÄ‚îÄ tsconfig.json            # Configura√ß√£o TypeScript
‚îî‚îÄ‚îÄ README.md                    # Este arquivo
```

## üöÄ Como Executar

### Pr√©-requisitos

- **Node.js 22+** (LTS)
- **Docker Desktop** instalado e rodando
- **Git**

### 1. Instalar Depend√™ncias

```bash
# Clone o reposit√≥rio
git clone https://github.com/marco-fabian/n8n_onfly_challenge_marco_fabian.git
cd n8n_onfly_challenge_marco_fabian

# Instalar depend√™ncias do custom node
cd n8n-node-random
npm install
```

### 2. Compilar o Custom Node

```bash
# Compilar TypeScript para JavaScript
npm run build
```

### 3. Configurar Ambiente

```bash
# Copiar arquivo de exemplo
cd ../n8n-infra
cp .env.example .env
```

**Editar o arquivo `.env` com suas pr√≥prias senhas:**
```env
POSTGRES_USER=n8n
POSTGRES_PASSWORD=sua_senha_do_db_aqui
POSTGRES_DB=n8n

N8N_ENCRYPTION_KEY=sua_senha_aqui
```

> **Importante**: Substitua os valores pelos seus pr√≥prios antes de executar o Docker Compose.

### 4. Executar Servi√ßos

```bash
# Subir n8n + PostgreSQL
docker compose up -d
```

### 5. Acessar n8n

Abra seu navegador em: **http://localhost:5678**

## üß™ Testando o Custom Node

### Testes Automatizados

O projeto inclui uma su√≠te de testes Jest para validar o funcionamento:

```bash
# Executar todos os testes
cd n8n-node-random
npm test

# Executar testes em modo watch
npm run test:watch

# Executar testes com coverage
npm run test:coverage

# Executar linting
npm run lint

# Formatar c√≥digo
npm run format
```

#### Tipos de Testes

- **API Tests**: Valida√ß√£o da integra√ß√£o com Random.org
- **Fallback Tests**: Verifica√ß√£o do sistema de fallback local
- **Build Tests**: Valida√ß√£o da compila√ß√£o TypeScript

### Teste Manual no n8n

1. **Criar novo workflow** no n8n
2. **Procurar por "Random"** na categoria "Transform"
3. **Configurar campos**:
   - Min: valor m√≠nimo (ex: 1)
   - Max: valor m√°ximo (ex: 100)
4. **Executar** o workflow
5. **Verificar resultado** com n√∫mero aleat√≥rio gerado

## üîß Funcionalidades

### Integra√ß√£o com Random.org
- Utiliza a API oficial: `https://www.random.org/integers/`
- Par√¢metros: `num=1&min={min}&max={max}&col=1&base=10&format=plain&rnd=new`

### Fallback Local
- Se a API do Random.org falhar, usa gera√ß√£o local
- Garante que o n√≥ sempre funcione

### Tratamento de Erro
- Try/catch para capturar erros da API
- Logs informativos sobre a fonte do n√∫mero


## üõ†Ô∏è Desenvolvimento

### Estrutura do C√≥digo

```typescript
// Random.node.ts
export class Random implements INodeType {
  description: INodeTypeDescription = {
    displayName: 'Random',
    name: 'random',
    icon: 'file:random.svg',
    // ... configura√ß√£o da UI
  };

  async execute(this: IExecuteFunctions): Promise<INodeExecutionData[][]> {
    // L√≥gica de execu√ß√£o com API Random.org
  }
}
```

### Compila√ß√£o

```bash
# Desenvolvimento (watch mode)
npm run dev

# Produ√ß√£o
npm run build

# Testes
npm test
```

## üìù Logs e Debug

```bash
# Ver logs do n8n
cd n8n-infra
docker compose logs n8n

# Ver logs do PostgreSQL
docker compose logs postgres

# Status dos containers
docker compose ps
```

## üîÑ Atualiza√ß√µes

Para atualizar o custom node ap√≥s mudan√ßas:

1. Execute o linting: `npm run lint`
2. Execute os testes: `npm test`
3. Compile o c√≥digo: `npm run build`
4. Copie o SVG: `cp src/nodes/Random/random.svg dist/nodes/Random/`
5. Reinicie o n8n: `docker compose restart n8n`

### CI/CD Pipeline

O projeto possui um pipeline automatizado que executa:
- ‚úÖ **Testes** em m√∫ltiplas vers√µes do Node.js (18, 20, 22)
- ‚úÖ **Linting** e formata√ß√£o de c√≥digo
- ‚úÖ **Build** e valida√ß√£o
- ‚úÖ **Docker** build test
- ‚úÖ **Security scan** com Trivy

## üìû Suporte

- **Autor**: Marco Fabian
- **Reposit√≥rio**: https://github.com/marco-fabian/n8n_onfly_challenge_marco_fabian
- **Documenta√ß√£o n8n**:
https://docs.n8n.io/hosting/installation/docker/
https://docs.n8n.io/integrations/creating-nodes/
https://docs.n8n.io/integrations/creating-nodes/test/run-node-locally/

## üîß Troubleshooting

### Problema: Erro de autentica√ß√£o do PostgreSQL
```bash
# Erro: password authentication failed for user "n8n"
# Solu√ß√£o 1: Verificar se as senhas no .env est√£o corretas
cat n8n-infra/.env

# Solu√ß√£o 2: Se mudou a senha, recriar o banco
docker compose down -v  # Remove volumes
docker compose up -d    # Recria com novas credenciais
```

### Problema: Erro de compila√ß√£o TypeScript
```bash
# Erro: Cannot find name 'ErrorOptions' ou m√≥dulos n√£o encontrados
# Solu√ß√£o: Reinstalar depend√™ncias com tipos corretos
cd n8n-node-random
rm -rf node_modules package-lock.json
npm install
npm run build
```

**Se ainda der erro:**
```bash
# Instalar depend√™ncias espec√≠ficas que podem estar faltando
npm install @types/express @types/ssh2
npm run build
```

### Problema: Testes falhando
```bash
# Erro: Test suite failed to run
# Solu√ß√£o: Verificar se Jest est√° configurado corretamente
cd n8n-node-random
npm test

# Se der erro de timeout, verificar conex√£o com internet ou aumentar o tempo de timeout
# Os testes de API precisam de conex√£o com Random.org
```

### Problema: SVG n√£o aparece no n8n
```bash
# Solu√ß√£o: Verificar se o SVG est√° na pasta dist
ls dist/nodes/Random/random.svg
# Se n√£o estiver, copiar manualmente:
cp src/nodes/Random/random.svg dist/nodes/Random/
```

### Problema: n8n n√£o reconhece o custom node
```bash
# Solu√ß√£o: Verificar se o arquivo compilado existe
ls dist/nodes/Random/Random.node.js
# Se n√£o existir, compilar novamente:
npm run build
```

## üìÑ Licen√ßa

MIT License 